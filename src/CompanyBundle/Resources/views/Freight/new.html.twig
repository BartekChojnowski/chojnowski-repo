{% extends '::base.html.twig' %}

{% block content -%}
    <a href="{{ path('freight') }}" class="btn-primary btn">Powr√≥t do listy</a>

    <h1>Nowe zlecenie</h1>

    {{ form_start(form) }}
    {{ form_errors(form) }}
    <div class="row">
        <div class="col-md-5">
            <div class="form-group">
                {{ form_row(form.number) }}
                {{ form_errors(form.number) }}
            </div>

            <div class="form-group">
                <div class="row">
                    <div class="col-md-2 text-right">{{ form_label(form.start) }}</div>
                    <div class="col-md-3">{{ form_widget(form.start) }}</div> -
                    <div class="col-md-3">{{ form_widget(form.end) }}</div>
                </div>
                {{ form_errors(form.start) }}
                {{ form_errors(form.end) }}
            </div>

            <div class="form-group">
                <div class="row">
                    <div class="col-md-10">{{ form_widget(form.startingPosition) }}</div>
                    <div class="col-md-2 text-right">
                        <button type="button" id="startingPosition-serach-btn" class="btn btn-default" aria-label="Szukaj"><span class="glyphicon glyphicon-search" aria-hidden="true"></span></button>
                        {#<button type="button" id="origin-pin-btn" class="btn btn-default" aria-label="Zaznacz"><span class="glyphicon glyphicon-map-marker" aria-hidden="true"></span></button>#}
                    </div>
                </div>
            </div>
            <div class="form-group">
                <div class="row">
                    <div class="col-md-10">{{ form_widget(form.origin) }}</div>
                    <div class="col-md-2 text-right">
                        <button type="button" id="origin-serach-btn" class="btn btn-default" aria-label="Szukaj"><span class="glyphicon glyphicon-search" aria-hidden="true"></span></button>
                        {#<button type="button" id="origin-pin-btn" class="btn btn-default" aria-label="Zaznacz"><span class="glyphicon glyphicon-map-marker" aria-hidden="true"></span></button>#}
                    </div>
                </div>
            </div>
            <div class="form-group">
                <div class="row">
                    <div class="col-md-10">{{ form_widget(form.destination) }}</div>
                    <div class="col-md-2 text-right">
                        <button type="button" id="destination-serach-btn" class="btn btn-default" aria-label="Szukaj"><span class="glyphicon glyphicon-search" aria-hidden="true"></span></button>
                        {#<button type="button" id="destination-pin-btn" class="btn btn-default" aria-label="Zaznacz"><span class="glyphicon glyphicon-map-marker" aria-hidden="true"></span></button>#}
                    </div>
                </div>
            </div>
            <div class="form-group">
                <div class="row">
                    <div class="col-md-2 nopadding text-right">
                        <label class="control-label" required="required" for="companybundle_freight_distance">zlecenie</label>
                    </div>
                    <div class="col-md-2 nopadding">{{ form_widget(form.distance) }}</div>
                    <div class="col-md-2 nopadding text-right">
                        <label class="control-label" required="required" for="companybundle_freight_distanceToOrigin">dojazd</label>
                    </div>
                    <div class="col-md-2 nopadding">{{ form_widget(form.distanceToOrigin) }}</div>
                    <div class="col-md-2 nopadding text-right">
                        <label class="control-label" for="companybundle_freight_distanceToOrigin">suma</label>
                    </div>
                    <div class="col-md-2 nopadding">
                        <input type="text" id="companybundle_freight_distanceSum" class="form-control">
                    </div>
                </div>
            </div>

            <div class="form-group">
                <div class="row">
                    <div class="col-md-2 text-right"> {{ form_label(form.price) }}</div>
                    <div class="col-md-4">{{ form_widget(form.price) }}</div>
                </div>
            </div>

            <div class="form-group">
                {{ form_row(form.driver) }}
                {{ form_errors(form.driver) }}
                {{ form_row(form.car) }}
                {{ form_errors(form.car) }}
            </div>

        </div>
        <div class="col-md-7">
            <div style="height:480px; width:600px;">
                <div id="map-canvas"  style="height:100%; width:100%;"></div>
            </div>
        </div>
    </div>

    <div class="form-group">
        {{ form_row(form.client) }}
        {{ form_errors(form.client) }}
    </div>
    <div class="form-group">
        {{ form_row(form.description) }}
        {{ form_errors(form.description) }}
    </div>

    {{ form_end(form) }}

    <script>
        function initMap() {

            var myLatlng = new google.maps.LatLng(52.069327, 19.480279);
            var map = new google.maps.Map(document.getElementById('map-canvas'), {
                zoom: 6,
                center: myLatlng,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                streetViewControl: false,
                disableDefaultUI: true
            });
            var geocoder = new google.maps.Geocoder();
            var directionsService = new google.maps.DirectionsService;
            var directionsDisplay = new google.maps.DirectionsRenderer({map: map});
            var startingPositionMarker = new google.maps.Marker();
            var originMarker = new google.maps.Marker();
            var destinationMarker = new google.maps.Marker();

            var startingPosition = $('#companybundle_freight_startingPosition_address');
            var startingPositionLatitide = $('#companybundle_freight_startingPosition_latitude');
            var startingPositionLogitude = $('#companybundle_freight_startingPosition_longitude');
            var origin = $('#companybundle_freight_origin_address');
            var originLatitide = $('#companybundle_freight_origin_latitude');
            var originLogitude = $('#companybundle_freight_origin_longitude');
            var destination = $('#companybundle_freight_destination_address');
            var destinationLatitide = $('#companybundle_freight_destination_latitude');
            var destinationLogitude = $('#companybundle_freight_destination_longitude');

            $('#startingPosition-serach-btn').click(function() {
                startingPositionMarker.setMap(null);
                geocodeAddress(geocoder, map, startingPositionMarker, startingPosition.val(), startingPositionLatitide, startingPositionLogitude);
                calculateAndDisplayRoute(directionsService, directionsDisplay, startingPosition.val(), origin.val(), destination.val());
            });

            $('#origin-serach-btn').click(function() {
                originMarker.setMap(null);
                geocodeAddress(geocoder, map, originMarker, origin.val(), originLatitide, originLogitude);
                calculateAndDisplayRoute(directionsService, directionsDisplay, startingPosition.val(), origin.val(), destination.val());
            });

            $('#destination-serach-btn').click(function() {
                destinationMarker.setMap(null);
                geocodeAddress(geocoder, map, destinationMarker, destination.val(), destinationLatitide, destinationLogitude);
                calculateAndDisplayRoute(directionsService, directionsDisplay, startingPosition.val(), origin.val(), destination.val());
            });
        }

        function geocodeAddress(geocoder, resultsMap, marker, address, lat, lng) {
            geocoder.geocode({'address': address}, function(results, status) {
                if (status === google.maps.GeocoderStatus.OK) {
                    resultsMap.setCenter(results[0].geometry.location);
                    marker = new google.maps.Marker({
                        map: resultsMap,
                        position: results[0].geometry.location
                    });

                    lat.val(results[0].geometry.location.lat);
                    lng.val(results[0].geometry.location.lng);
                }
            });
        }

        function calculateAndDisplayRoute(directionsService, directionsDisplay, startingPositionAddress, originAddress, destinationAddress) {
            var waypts = [];
            var freightDistanceElement = $('#companybundle_freight_distance');
            var toOriginDistanceElement = $('#companybundle_freight_distanceToOrigin');
            var distanceSumElement = $('#companybundle_freight_distanceSum');

            freightDistanceElement.val('');
            toOriginDistanceElement.val('');
            distanceSumElement.val('');

            if (startingPositionAddress != '') {
                waypts.push({
                    location: originAddress,
                    stopover: true
                });

                originAddress = startingPositionAddress;
                var isDistanceToOrigin = true;
            }

            directionsService.route({
                origin: originAddress,
                destination: destinationAddress,
                travelMode: google.maps.TravelMode.DRIVING,
                unitSystem: google.maps.UnitSystem.METRIC,
                waypoints: waypts,
                optimizeWaypoints: true
            }, function(response, status) {
                if (status === google.maps.DirectionsStatus.OK) {
                    directionsDisplay.setDirections(response);
                    var route = response.routes[0];
                    var distance = 0;
                    for (var i = 0; i < route.legs.length; i++) {
                        if (isDistanceToOrigin) {
                            toOriginDistanceElement.val(Math.round(route.legs[i].distance.value/1000));
                            isDistanceToOrigin = false;
                        } else {
                            distance += route.legs[i].distance.value;
                        }
                    }

                    freightDistanceElement.val(Math.round(distance/1000));

                    distanceSumElement.val(parseInt(freightDistanceElement.val()) + parseInt(toOriginDistanceElement.val()));
                }
            });
        }

        function calculateDistance() {
            var totalDistance = 0;
            var totalDuration = 0;
            var legs = directionsResult.routes[0].legs;
            for(var i=0; i<legs.length; ++i) {
                totalDistance += legs[i].distance.value;
                totalDuration += legs[i].duration.value;
            }
        }
//        $(document).ready(function(){
//
//        });
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBDZtW0AjODCeKfQKFC3YBN9O6DjQIuQOI&signed_in=false&callback=initMap" async defer></script>
</div>


{% endblock %}
